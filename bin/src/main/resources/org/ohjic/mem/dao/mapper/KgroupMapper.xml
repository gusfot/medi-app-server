<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.ohjic.mem.dao.KgroupMapper">
  <resultMap id="BaseResultMap" type="org.ohjic.mem.model.Kgroup">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 21 14:44:49 KST 2016.
    -->
    <id column="no" jdbcType="INTEGER" property="no" />
    <id column="year" jdbcType="INTEGER" property="year" />
    <result column="k_part_idx" jdbcType="INTEGER" property="kPartIdx" />
    <result column="depth1" jdbcType="INTEGER" property="depth1" />
    <result column="depth2" jdbcType="INTEGER" property="depth2" />
    <result column="depth3" jdbcType="INTEGER" property="depth3" />
    <result column="depth4" jdbcType="INTEGER" property="depth4" />
    <result column="depth5" jdbcType="INTEGER" property="depth5" />
    <result column="ord" jdbcType="INTEGER" property="ord" />
    <result column="depth1_name" jdbcType="VARCHAR" property="depth1Name" />
    <result column="depth2_name" jdbcType="VARCHAR" property="depth2Name" />
    <result column="depth3_name" jdbcType="VARCHAR" property="depth3Name" />
    <result column="depth4_name" jdbcType="VARCHAR" property="depth4Name" />
    <result column="depth5_name" jdbcType="VARCHAR" property="depth5Name" />
    <result column="depth" jdbcType="BIT" property="depth" />
    <result column="group_name" jdbcType="VARCHAR" property="groupName" />
    <result column="start_date" jdbcType="INTEGER" property="startDate" />
    <result column="end_date" jdbcType="INTEGER" property="endDate" />
    <result column="reportType" jdbcType="CHAR" property="reportType" />
    <result column="reg_date" jdbcType="TIMESTAMP" property="regDate" />
  </resultMap>
  <resultMap extends="BaseResultMap" id="ResultMapWithBLOBs" type="org.ohjic.mem.model.Kgroup">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 21 14:44:49 KST 2016.
    -->
    <result column="reportItem" jdbcType="LONGVARCHAR" property="reportItem" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 21 14:44:49 KST 2016.
    -->
    no, year, k_part_idx, depth1, depth2, depth3, depth4, depth5, ord, depth1_name, depth2_name, 
    depth3_name, depth4_name, depth5_name, depth, group_name, start_date, end_date, reportType, 
    reg_date
  </sql>
  <sql id="Blob_Column_List">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 21 14:44:49 KST 2016.
    -->
    reportItem
  </sql>
  <select id="selectByPrimaryKey" parameterType="org.ohjic.mem.model.KgroupKey" resultMap="ResultMapWithBLOBs">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 21 14:44:49 KST 2016.
    -->
    select 
    <include refid="Base_Column_List" />
    ,
    <include refid="Blob_Column_List" />
    from ${church}.kGroup
    where no = #{no,jdbcType=INTEGER}
      and year = #{year,jdbcType=INTEGER}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="org.ohjic.mem.model.KgroupKey">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 21 14:44:49 KST 2016.
    -->
    delete from ${church}.kGroup
    where no = #{no,jdbcType=INTEGER}
      and year = #{year,jdbcType=INTEGER}
  </delete>
  <insert id="insert" parameterType="org.ohjic.mem.model.Kgroup">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 21 14:44:49 KST 2016.
    -->
    insert into ${church}.kGroup (no, year, k_part_idx, 
      depth1, depth2, depth3, 
      depth4, depth5, ord, 
      depth1_name, depth2_name, depth3_name, 
      depth4_name, depth5_name, depth, 
      group_name, start_date, end_date, 
      reportType, reg_date, reportItem
      )
    values (#{no,jdbcType=INTEGER}, #{year,jdbcType=INTEGER}, #{kPartIdx,jdbcType=INTEGER}, 
      #{depth1,jdbcType=INTEGER}, #{depth2,jdbcType=INTEGER}, #{depth3,jdbcType=INTEGER}, 
      #{depth4,jdbcType=INTEGER}, #{depth5,jdbcType=INTEGER}, #{ord,jdbcType=INTEGER}, 
      #{depth1Name,jdbcType=VARCHAR}, #{depth2Name,jdbcType=VARCHAR}, #{depth3Name,jdbcType=VARCHAR}, 
      #{depth4Name,jdbcType=VARCHAR}, #{depth5Name,jdbcType=VARCHAR}, #{depth,jdbcType=BIT}, 
      #{groupName,jdbcType=VARCHAR}, #{startDate,jdbcType=INTEGER}, #{endDate,jdbcType=INTEGER}, 
      #{reportType,jdbcType=CHAR}, #{regDate,jdbcType=TIMESTAMP}, #{reportItem,jdbcType=LONGVARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="org.ohjic.mem.model.Kgroup">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 21 14:44:49 KST 2016.
    -->
    insert into ${church}.kGroup
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="no != null">
        no,
      </if>
      <if test="year != null">
        year,
      </if>
      <if test="kPartIdx != null">
        k_part_idx,
      </if>
      <if test="depth1 != null">
        depth1,
      </if>
      <if test="depth2 != null">
        depth2,
      </if>
      <if test="depth3 != null">
        depth3,
      </if>
      <if test="depth4 != null">
        depth4,
      </if>
      <if test="depth5 != null">
        depth5,
      </if>
      <if test="ord != null">
        ord,
      </if>
      <if test="depth1Name != null">
        depth1_name,
      </if>
      <if test="depth2Name != null">
        depth2_name,
      </if>
      <if test="depth3Name != null">
        depth3_name,
      </if>
      <if test="depth4Name != null">
        depth4_name,
      </if>
      <if test="depth5Name != null">
        depth5_name,
      </if>
      <if test="depth != null">
        depth,
      </if>
      <if test="groupName != null">
        group_name,
      </if>
      <if test="startDate != null">
        start_date,
      </if>
      <if test="endDate != null">
        end_date,
      </if>
      <if test="reportType != null">
        reportType,
      </if>
      <if test="regDate != null">
        reg_date,
      </if>
      <if test="reportItem != null">
        reportItem,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="no != null">
        #{no,jdbcType=INTEGER},
      </if>
      <if test="year != null">
        #{year,jdbcType=INTEGER},
      </if>
      <if test="kPartIdx != null">
        #{kPartIdx,jdbcType=INTEGER},
      </if>
      <if test="depth1 != null">
        #{depth1,jdbcType=INTEGER},
      </if>
      <if test="depth2 != null">
        #{depth2,jdbcType=INTEGER},
      </if>
      <if test="depth3 != null">
        #{depth3,jdbcType=INTEGER},
      </if>
      <if test="depth4 != null">
        #{depth4,jdbcType=INTEGER},
      </if>
      <if test="depth5 != null">
        #{depth5,jdbcType=INTEGER},
      </if>
      <if test="ord != null">
        #{ord,jdbcType=INTEGER},
      </if>
      <if test="depth1Name != null">
        #{depth1Name,jdbcType=VARCHAR},
      </if>
      <if test="depth2Name != null">
        #{depth2Name,jdbcType=VARCHAR},
      </if>
      <if test="depth3Name != null">
        #{depth3Name,jdbcType=VARCHAR},
      </if>
      <if test="depth4Name != null">
        #{depth4Name,jdbcType=VARCHAR},
      </if>
      <if test="depth5Name != null">
        #{depth5Name,jdbcType=VARCHAR},
      </if>
      <if test="depth != null">
        #{depth,jdbcType=BIT},
      </if>
      <if test="groupName != null">
        #{groupName,jdbcType=VARCHAR},
      </if>
      <if test="startDate != null">
        #{startDate,jdbcType=INTEGER},
      </if>
      <if test="endDate != null">
        #{endDate,jdbcType=INTEGER},
      </if>
      <if test="reportType != null">
        #{reportType,jdbcType=CHAR},
      </if>
      <if test="regDate != null">
        #{regDate,jdbcType=TIMESTAMP},
      </if>
      <if test="reportItem != null">
        #{reportItem,jdbcType=LONGVARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="org.ohjic.mem.model.Kgroup">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 21 14:44:49 KST 2016.
    -->
    update ${church}.kGroup
    <set>
      <if test="kPartIdx != null">
        k_part_idx = #{kPartIdx,jdbcType=INTEGER},
      </if>
      <if test="depth1 != null">
        depth1 = #{depth1,jdbcType=INTEGER},
      </if>
      <if test="depth2 != null">
        depth2 = #{depth2,jdbcType=INTEGER},
      </if>
      <if test="depth3 != null">
        depth3 = #{depth3,jdbcType=INTEGER},
      </if>
      <if test="depth4 != null">
        depth4 = #{depth4,jdbcType=INTEGER},
      </if>
      <if test="depth5 != null">
        depth5 = #{depth5,jdbcType=INTEGER},
      </if>
      <if test="ord != null">
        ord = #{ord,jdbcType=INTEGER},
      </if>
      <if test="depth1Name != null">
        depth1_name = #{depth1Name,jdbcType=VARCHAR},
      </if>
      <if test="depth2Name != null">
        depth2_name = #{depth2Name,jdbcType=VARCHAR},
      </if>
      <if test="depth3Name != null">
        depth3_name = #{depth3Name,jdbcType=VARCHAR},
      </if>
      <if test="depth4Name != null">
        depth4_name = #{depth4Name,jdbcType=VARCHAR},
      </if>
      <if test="depth5Name != null">
        depth5_name = #{depth5Name,jdbcType=VARCHAR},
      </if>
      <if test="depth != null">
        depth = #{depth,jdbcType=BIT},
      </if>
      <if test="groupName != null">
        group_name = #{groupName,jdbcType=VARCHAR},
      </if>
      <if test="startDate != null">
        start_date = #{startDate,jdbcType=INTEGER},
      </if>
      <if test="endDate != null">
        end_date = #{endDate,jdbcType=INTEGER},
      </if>
      <if test="reportType != null">
        reportType = #{reportType,jdbcType=CHAR},
      </if>
      <if test="regDate != null">
        reg_date = #{regDate,jdbcType=TIMESTAMP},
      </if>
      <if test="reportItem != null">
        reportItem = #{reportItem,jdbcType=LONGVARCHAR},
      </if>
    </set>
    where no = #{no,jdbcType=INTEGER}
      and year = #{year,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKeyWithBLOBs" parameterType="org.ohjic.mem.model.Kgroup">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 21 14:44:49 KST 2016.
    -->
    update ${church}.kGroup
    set k_part_idx = #{kPartIdx,jdbcType=INTEGER},
      depth1 = #{depth1,jdbcType=INTEGER},
      depth2 = #{depth2,jdbcType=INTEGER},
      depth3 = #{depth3,jdbcType=INTEGER},
      depth4 = #{depth4,jdbcType=INTEGER},
      depth5 = #{depth5,jdbcType=INTEGER},
      ord = #{ord,jdbcType=INTEGER},
      depth1_name = #{depth1Name,jdbcType=VARCHAR},
      depth2_name = #{depth2Name,jdbcType=VARCHAR},
      depth3_name = #{depth3Name,jdbcType=VARCHAR},
      depth4_name = #{depth4Name,jdbcType=VARCHAR},
      depth5_name = #{depth5Name,jdbcType=VARCHAR},
      depth = #{depth,jdbcType=BIT},
      group_name = #{groupName,jdbcType=VARCHAR},
      start_date = #{startDate,jdbcType=INTEGER},
      end_date = #{endDate,jdbcType=INTEGER},
      reportType = #{reportType,jdbcType=CHAR},
      reg_date = #{regDate,jdbcType=TIMESTAMP},
      reportItem = #{reportItem,jdbcType=LONGVARCHAR}
    where no = #{no,jdbcType=INTEGER}
      and year = #{year,jdbcType=INTEGER}
  </update>
  <update id="updateByPrimaryKey" parameterType="org.ohjic.mem.model.Kgroup">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Dec 21 14:44:49 KST 2016.
    -->
    update ${church}.kGroup
    set k_part_idx = #{kPartIdx,jdbcType=INTEGER},
      depth1 = #{depth1,jdbcType=INTEGER},
      depth2 = #{depth2,jdbcType=INTEGER},
      depth3 = #{depth3,jdbcType=INTEGER},
      depth4 = #{depth4,jdbcType=INTEGER},
      depth5 = #{depth5,jdbcType=INTEGER},
      ord = #{ord,jdbcType=INTEGER},
      depth1_name = #{depth1Name,jdbcType=VARCHAR},
      depth2_name = #{depth2Name,jdbcType=VARCHAR},
      depth3_name = #{depth3Name,jdbcType=VARCHAR},
      depth4_name = #{depth4Name,jdbcType=VARCHAR},
      depth5_name = #{depth5Name,jdbcType=VARCHAR},
      depth = #{depth,jdbcType=BIT},
      group_name = #{groupName,jdbcType=VARCHAR},
      start_date = #{startDate,jdbcType=INTEGER},
      end_date = #{endDate,jdbcType=INTEGER},
      reportType = #{reportType,jdbcType=CHAR},
      reg_date = #{regDate,jdbcType=TIMESTAMP}
    where no = #{no,jdbcType=INTEGER}
      and year = #{year,jdbcType=INTEGER}
  </update>
  
  <select id="selectKgroupByYear" parameterType="org.ohjic.mem.model.Kgroup" resultMap="ResultMapWithBLOBs">
  select     
  	<include refid="Base_Column_List" />
    ,<include refid="Blob_Column_List" /> 
  from ${church}.kGrouplog where year=#{year}
  </select>
  
  <insert id="insertNextYearKgroupByYear" parameterType="org.ohjic.mem.vo.YearVo" >
  insert ${church}.kGroup(year, k_part_idx, depth1, depth2, depth3, depth4, depth5, ord, depth1_name, depth2_name, depth3_name, depth4_name, depth5_name, depth, group_name, start_date, end_date, reportType, reportItem)
	select 
	 #{nextYear} year, a.k_part_idx, depth1, depth2, depth3, depth4, depth5, ord, depth1_name, depth2_name, depth3_name, depth4_name, depth5_name, depth, group_name, 
	 UNIX_TIMESTAMP(STR_TO_DATE(concat(#{nextYear},'-01-01'),'%Y-%m-%d')) start_date, 
	 UNIX_TIMESTAMP(STR_TO_DATE(concat((#{nextYear}+1),'-01-01'),'%Y-%m-%d'))-1 end_date, 
	 reportType, reportItem
	 from ${church}.kGroup a 
	inner join ${church}.k_part b on a.k_part_idx = b.k_part_idx and b.active=1
	where a.year=#{year} 
	<if test="kPartIdx != null and kPartIdx != 0 ">
	and a.k_part_idx = #{kPartIdx}
	</if>
	<!-- and unix_timestamp(now()) between start_date and end_date -->
  </insert>
  
  <update id="updateNextYearKgroupDepthByYear" parameterType="org.ohjic.mem.vo.YearVo">
	update ${church}.kGroup a

	<if test="depth >= 2"> 
		inner join ${church}.kGroup b on a.depth1_name=b.group_name and a.k_part_idx=b.k_part_idx and b.depth=1 and b.year=#{nextYear}
	</if>
	<if test="depth >= 3">
		inner join ${church}.kGroup c on a.depth2_name=c.group_name and a.k_part_idx=c.k_part_idx and a.depth1_name=c.depth1_name and c.depth=2 and c.year=#{nextYear}
	</if>
	<if test="depth >= 4">
		inner join ${church}.kGroup d on a.depth3_name=d.group_name and a.k_part_idx=d.k_part_idx and a.depth1_name=d.depth1_name and a.depth2_name=d.depth2_name and d.depth=3 and d.year=#{nextYear}
	</if>
	<if test="depth >= 5">
		inner join ${church}.kGroup e on a.depth4_name=e.group_name and a.k_part_idx=b.k_part_idx and a.depth1_name=e.depth1_name and a.depth2_name=e.depth2_name and a.depth3_name=e.depth3_name and e.depth=4 and e.year=#{nextYear}
	</if>
	
	<if test="depth == 1">
	set a.depth1=no
	</if>
	<if test="depth == 2">
	set a.depth2=a.no, a.depth1=b.no
	</if>
	<if test="depth == 3">
	set a.depth3=a.no, a.depth1=b.no, a.depth2=c.no
	</if>
	<if test="depth == 4">
	set a.depth4=a.no, a.depth1=b.no, a.depth2=c.no, a.depth3=d.no
	</if>
	<if test="depth == 5">
	set a.depth5=a.no, a.depth1=b.no, a.depth2=c.no, a.depth3=d.no, a.depth4=e.no
	</if>
	where a.depth=#{depth} and a.year=#{nextYear}
  </update>
  
  <insert id="deleteNextYearKgroup" parameterType="org.ohjic.mem.vo.YearVo">
  	delete from ${church}.kGroup where year=#{nextYear} and k_part_idx=#{kPartIdx} 
  </insert>
</mapper>