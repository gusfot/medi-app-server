<%
	//************************************************************************
	//																		//
	//		º» »ùÇÃ¼Ò½º´Â °³¹ß ¹× Å×½ºÆ®¸¦ À§ÇÑ ¸ñÀûÀ¸·Î ¸¸µé¾îÁ³À¸¸ç,		//
	//																		//
	//		½ÇÁ¦ ¼­ºñ½º¿¡ ±×´ë·Î »ç¿ëÇÏ´Â °ÍÀ» ±İÇÕ´Ï´Ù.					//
	//																		//
	//************************************************************************
%>
<%
	response.setHeader("Pragma","no-cache");			// HTTP1.0 Ä³½¬ ¹æÁö
	response.setDateHeader("Expires",0);				// proxy ¼­¹öÀÇ Ä³½¬ ¹æÁö
	response.setHeader("Pragma", "no-store");			// HTTP1.1 Ä³½¬ ¹æÁö
	if(request.getProtocol().equals("HTTP/1.1"))
			response.setHeader("Cache-Control", "no-cache"); // HTTP1.1 Ä³½¬ ¹æÁö
%>
<%@ page  contentType = "text/html;charset=ksc5601"%>
<%@ page import = "java.util.*" %>
<%@ page import = "java.util.regex.*" %>
<%@ page import = "java.text.*" %>
    [º»ÀÎÀÎÁõ¼­ºñ½º Å×½ºÆ® °á°ú ¼ö½Å Sample] <br> <br>
<%
    // º¯¼ö¼±¾ğ --------------------------------------------------------------------------------------------------------
    String rec_cert		= "";           // °á°ú¼ö½ÅDATA

	String k_certNum = "";			    // ÆÄ¶ó¹ÌÅÍ·Î ¼ö½ÅÇÑ ¿äÃ»¹øÈ£
	String certNum		= "";			// ¿äÃ»¹øÈ£
    String date			= "";			// ¿äÃ»ÀÏ½Ã
	String CI	    	= "";			// ¿¬°èÁ¤º¸(CI)
	String DI	    	= "";			// Áßº¹°¡ÀÔÈ®ÀÎÁ¤º¸(DI)
    String phoneNo		= "";			// ÈŞ´ëÆù¹øÈ£
	String phoneCorp	= "";			// ÀÌµ¿Åë½Å»ç
	String birthDay		= "";			// »ı³â¿ùÀÏ
	String gender		= "";			// ¼ºº°
	String nation		= "";			// ³»±¹ÀÎ
	String name			= "";			// ¼º¸í
	String M_name		= "";			// ¹Ì¼º³âÀÚ ¼º¸í
	String M_birthDay	= "";			// ¹Ì¼º³âÀÚ »ı³â¿ùÀÏ
	String M_Gender		= "";			// ¹Ì¼º³âÀÚ ¼ºº°
	String M_nation		= "";			// ¹Ì¼º³âÀÚ ³»¿Ü±¹ÀÎ
    String result		= "";			// °á°ú°ª

    String certMet		= "";			// ÀÎÁõ¹æ¹ı
    String ip			= "";			// ipÁÖ¼Ò
	String plusInfo		= "";

	String encPara		= "";
	String encMsg1		= ""; 
	String encMsg2		= "";
	String msgChk       = "";
    //-----------------------------------------------------------------------------------------------------------------

    try{

        // Parameter ¼ö½Å --------------------------------------------------------------------
        rec_cert       = request.getParameter("rec_cert").trim();
        k_certNum      = request.getParameter("certNum").trim(); 

%>
            [º¹È£È­ ÇÏ±âÀü ¼ö½Å°ª] <br>
            <br>
            rec_cert : <%=rec_cert%> <br>
            <br>
<%
        //01. ¾ÏÈ£È­ ¸ğµâ (jar) Loading
        com.icert.comm.secu.IcertSecuManager seed = new com.icert.comm.secu.IcertSecuManager();

        //02. 1Â÷ º¹È£È­
        //¼ö½ÅµÈ certNum¸¦ ÀÌ¿ëÇÏ¿© º¹È£È­
        rec_cert  = seed.getDec(rec_cert, k_certNum);

        //03. 1Â÷ ÆÄ½Ì
        int inf1 = rec_cert.indexOf("/",0);
        int inf2 = rec_cert.indexOf("/",inf1+1);

		encPara  = rec_cert.substring(0,inf1);         //¾ÏÈ£È­µÈ ÅëÇÕ ÆÄ¶ó¹ÌÅÍ
        encMsg1  = rec_cert.substring(inf1+1,inf2);    //¾ÏÈ£È­µÈ ÅëÇÕ ÆÄ¶ó¹ÌÅÍÀÇ Hash°ª

		//04. À§º¯Á¶ °ËÁõ
		encMsg2  = seed.getMsg(encPara);

        if(encMsg2.equals(encMsg1)){
            msgChk="Y";
        }

		if(msgChk.equals("N")){
%>
		    <script language=javascript>
            alert("ºñÁ¤»óÀûÀÎ Á¢±ÙÀÔ´Ï´Ù.!!<%=msgChk%>");
		    </script>
<%
			return;
		}

        //05. 2Â÷ º¹È£È­
		rec_cert  = seed.getDec(encPara, k_certNum);

        //06. 2Â÷ ÆÄ½Ì
        int info1  = rec_cert.indexOf("/",0);
        int info2  = rec_cert.indexOf("/",info1+1);
        int info3  = rec_cert.indexOf("/",info2+1);
        int info4  = rec_cert.indexOf("/",info3+1);
        int info5  = rec_cert.indexOf("/",info4+1);
        int info6  = rec_cert.indexOf("/",info5+1);
        int info7  = rec_cert.indexOf("/",info6+1);
        int info8  = rec_cert.indexOf("/",info7+1);
		int info9  = rec_cert.indexOf("/",info8+1);
		int info10 = rec_cert.indexOf("/",info9+1);
		int info11 = rec_cert.indexOf("/",info10+1);
		int info12 = rec_cert.indexOf("/",info11+1);
		int info13 = rec_cert.indexOf("/",info12+1);
		int info14 = rec_cert.indexOf("/",info13+1);
		int info15 = rec_cert.indexOf("/",info14+1);
		int info16 = rec_cert.indexOf("/",info15+1);
		int info17 = rec_cert.indexOf("/",info16+1);
		int info18 = rec_cert.indexOf("/",info17+1);

        certNum		= rec_cert.substring(0,info1);
        date		= rec_cert.substring(info1+1,info2);
        CI			= rec_cert.substring(info2+1,info3);
        phoneNo		= rec_cert.substring(info3+1,info4);
        phoneCorp	= rec_cert.substring(info4+1,info5);
        birthDay	= rec_cert.substring(info5+1,info6);
        gender		= rec_cert.substring(info6+1,info7);
        nation		= rec_cert.substring(info7+1,info8);
		name		= rec_cert.substring(info8+1,info9);
		result		= rec_cert.substring(info9+1,info10);
		certMet		= rec_cert.substring(info10+1,info11);
		ip			= rec_cert.substring(info11+1,info12);
		M_name		= rec_cert.substring(info12+1,info13);
		M_birthDay	= rec_cert.substring(info13+1,info14);
		M_Gender	= rec_cert.substring(info14+1,info15);
		M_nation	= rec_cert.substring(info15+1,info16);
		plusInfo	= rec_cert.substring(info16+1,info17);
		DI      	= rec_cert.substring(info17+1,info18);

        //07. CI, DI º¹È£È­
        CI  = seed.getDec(CI, k_certNum);
        DI  = seed.getDec(DI, k_certNum);
%>	
<%!
		// ÆÄ¶ó¹ÌÅÍ À¯È¿¼º °ËÁõ --------------------------------------------
		boolean b = true;
		String regex = "";

		public Boolean paramChk(String patn, String param){
			Pattern pattern = Pattern.compile(patn);
			Matcher matcher = pattern.matcher(param);
			b = matcher.matches();
			return b;
		}
%>
<%
		if( certNum.length() == 0 || certNum.length() > 40){
			out.println("¿äÃ»¹øÈ£ ºñÁ¤»ó");
			return;
		}

		regex = "[0-9]*";
		if( date.length() != 14 || !paramChk(regex, date) ){
			out.println("¿äÃ»ÀÏ½Ã ºñÁ¤»ó");
			return;
		}

		regex = "[A-Z]*";
		if( certMet.length() != 1 || !paramChk(regex, certMet) ){
			out.println("º»ÀÎÀÎÁõ¹æ¹ı ºñÁ¤»ó" + certMet);
			return;
		}


		regex = "[0-9]*";
		if( (phoneNo.length() != 10 && phoneNo.length() != 11) || !paramChk(regex, phoneNo) ){
			out.println("ÈŞ´ëÆù¹øÈ£ ºñÁ¤»ó");
			return;
		}
		
		regex = "[A-Z]*";
		if( phoneCorp.length() != 3 || !paramChk(regex, phoneCorp) ){
			out.println("ÀÌµ¿Åë½Å»ç ºñÁ¤»ó");
			return;
		}

		regex = "[0-9]*";
		if( birthDay.length() != 8 || !paramChk(regex, birthDay) ){
			out.println("»ı³â¿ùÀÏ ºñÁ¤»ó");
			return;
		}

		regex = "[0-9]*";
		if( gender.length() != 1 || !paramChk(regex, gender) ){
			out.println("¼ºº° ºñÁ¤»ó");
			return;
		}

		regex = "[0-9]*";
		if( nation.length() != 1 || !paramChk(regex, nation) ){
			out.println("³»/¿Ü±¹ÀÎ ºñÁ¤»ó");
			return;
		}
		
		regex = "[\\sA-Za-z°¡-ÆR.,-]*";
		if( name.length() > 60 || !paramChk(regex, name) ){
			out.println("¼º¸í ºñÁ¤»ó");
			return;
		}
		
		regex = "[A-Z]*";
		if( result.length() != 1 || !paramChk(regex, result) ){
			out.println("°á°ú°ª ºñÁ¤»ó");
			return;
		}
		
		regex = "[\\sA-Za-z°¡-?.,-]*";
		if( M_name.length() != 0 ){
			if( M_name.length() > 60 || !paramChk(regex, M_name) ){
				out.println("¹Ì¼º³âÀÚ ¼º¸í ºñÁ¤»ó");
				return;
			}
		}
		
		regex = "[0-9]*";
		if( M_birthDay.length() != 0 ){
			if( M_birthDay.length() != 8 || !paramChk(regex, M_birthDay) ){
				out.println("¹Ì¼º³âÀÚ »ı³â¿ùÀÏ ºñÁ¤»ó");
				return;
			}
		}

		regex = "[0-9]*";
		if( M_Gender.length() != 0 ){
			if( M_Gender.length() != 1 || !paramChk(regex, M_Gender) ){
				out.println("¹Ì¼º³âÀÚ ¼ºº° ºñÁ¤»ó");
				return;
			}
		}

		regex = "[0-9]*";
		if( M_nation.length() != 0 ){
			if( M_nation.length() != 1 || !paramChk(regex, M_nation) ){
				out.println("¹Ì¼º³âÀÚ ³»/¿Ü±¹ÀÎ ºñÁ¤»ó");
				return;
			}
		}
		// End ÆÄ¶ó¹ÌÅÍ À¯È¿¼º °ËÁõ --------------------------------------------

		// Start - ¼ö½Å³»¿ª À¯È¿¼º °ËÁõ(»ç¼³¸ÁÀÇ »ç¼³ IP·Î ÀÎÇØ ¹Ì»ç¿ë, °ø¿ë¸ÁÀÇ °æ¿ì È®ÀÎ ÈÄ »ç¿ë) *********************/
		// 1. date °ª °ËÁõ
		SimpleDateFormat formatter	= new SimpleDateFormat("yyyyMMddHHmmss",Locale.KOREAN); // ÇöÀç ¼­¹ö ½Ã°¢ ±¸ÇÏ±â
		String strCurrentTime	= formatter.format(new Date());
		
		Date toDate				= formatter.parse(strCurrentTime);
		Date fromDate			= formatter.parse(date);
		long timediff			= toDate.getTime()-fromDate.getTime();
		
		if ( timediff < -30*60*1000 || 30*60*100 < timediff  ){		%>
			ºñÁ¤»óÀûÀÎ Á¢±ÙÀÔ´Ï´Ù. (¿äÃ»½Ã°£°æ°ú)
<%			return;
		}
		
		// 2. ip °ª °ËÁõ
		String client_ip = request.getHeader("HTTP_X_FORWARDED_FOR"); // »ç¿ëÀÚIP ±¸ÇÏ±â
		if ( client_ip != null ){
			if( client_ip.indexOf(",") != -1 )
				client_ip = client_ip.substring(0,client_ip.indexOf(","));
		}
		if ( client_ip==null || client_ip.length()==0 ){
			client_ip = request.getRemoteAddr();
		}

		if( !client_ip.equals(ip) ){		%>

			ºñÁ¤»óÀûÀÎ Á¢±ÙÀÔ´Ï´Ù. (IPºÒÀÏÄ¡)
<%			return;
		}
		// End - ¼ö½Å³»¿ª À¯È¿¼º °ËÁõ(»ç¼³¸ÁÀÇ »ç¼³ IP·Î ÀÎÇØ ¹Ì»ç¿ë, °ø¿ë¸ÁÀÇ °æ¿ì È®ÀÎ ÈÄ »ç¿ë) ***********************/
%>
<html>
	<head>
		<meta name="robots" content="noindex">
	</head>
	<body>
		<br><br>
            [º¹È£È­ ÈÄ ¼ö½Å°ª] <br>
            <br>
            <table cellpadding=1 cellspacing=1>
                <tr>
                    <td align=left>À§,º¯Á¶¿©ºÎ1</td>
                    <td align=left><%=encMsg1%></td>
                </tr>
                <tr>
                    <td align=left>À§,º¯Á¶¿©ºÎ2</td>
                    <td align=left><%=encMsg2%></td>
                </tr>

                <tr>
                    <td align=left>¿äÃ»¹øÈ£</td>
                    <td align=left><%=certNum%></td>
                </tr>
                <tr>
                    <td align=left>¿äÃ»ÀÏ½Ã</td>
                    <td align=left><%=date%></td>
                </tr>
                <tr>
                    <td align=left>¿¬°èÁ¤º¸(CI)</td>
                    <td align=left><%=CI%></td>
                </tr>
                <tr>
                    <td align=left>Áßº¹°¡ÀÔÈ®ÀÎÁ¤º¸(DI)</td>
                    <td align=left><%=DI%></td>
                </tr>
                <tr>
                    <td align=left>ÈŞ´ëÆù¹øÈ£</td>
                    <td align=left><%=phoneNo%></td>
                </tr>
                <tr>
                    <td align=left>ÀÌµ¿Åë½Å»ç</td>
                    <td align=left><%=phoneCorp%></td>
                </tr>
                <tr>
                    <td align=left>»ı³â¿ùÀÏ</td>
                    <td align=left><%=birthDay%></td>
                </tr>
                <tr>
                    <td align=left>³»±¹ÀÎ</td>
                    <td align=left><%=nation%></td>
                </tr>
                <tr>
                    <td align=left>¼ºº°</td>
                    <td align=left><%=gender%></td>
                </tr>
                <tr>
                    <td align=left>¼º¸í</td>
                    <td align=left><%=name%></td>
                </tr>
                <tr>
                    <td align=left>°á°ú°ª</td>
                    <td align=left><%=result%></td>
                </tr>
                <tr>
                    <td align=left>ÀÎÁõ¹æ¹ı</td>
                    <td align=left><%=certMet%></td>
                    </td>
                </tr>
                <tr>
                    <td align=left>ipÁÖ¼Ò</td>
                    <td align=left><%=ip%></td>
                </tr>
                <tr>
                    <td align=left>¹Ì¼º³âÀÚ ¼º¸í</td>
                    <td align=left><%=M_name%></td>
                </tr>
                <tr>
                    <td align=left>¹Ì¼º³âÀÚ »ı³â¿ùÀÏ</td>
                    <td align=left><%=M_birthDay%></td>
                </tr>
                <tr>
                    <td align=left>¹Ì¼º³âÀÚ ¼ºº°</td>
                    <td align=left><%=M_Gender%></td>
                    </td>
                </tr>
                <tr>
                    <td align=left>¹Ì¼º³âÀÚ ³»¿Ü±¹ÀÎ</td>
                    <td align=left><%=M_nation%></td>
                </tr>
                <tr>
                    <td align=left>Ãß°¡DATAÁ¤º¸</td>
                    <td align=left><%=plusInfo%></td>
                </tr>
            </table>

            <br>
            rec_cert : <%=rec_cert%> <br>
            <br>
            <br>
            <a href="http://È¸¿ø»çº° °æ·Î/kmcis_web_sample_step01.jsp">[´Ù½Ã Å×½ºÆ®]</a>
	</body>
</html>
        <%
    }catch(Exception ex){
          System.out.println("[KMCIS] Receive Error -"+ex.getMessage());
    }
%>